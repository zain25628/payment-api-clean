# خطة لوحة إدارة المشروع (Admin Dashboard) — نظرة عامة وخطة تطوير

## 1. نظرة عامة سريعة على اللوحة الحالية

- مكان الملف الرئيسي للمشروع: `admin-frontend/src/`.

- الصفحات/الشاشات الموجودة فعليًا (مستخلصة من الشجرة الحالية):
  - `src/routes/CompaniesList.tsx` → شاشة عرض الشركات (Companies list).
  - `src/routes/CompanyForm.tsx` → شاشة إنشاء/تعديل شركة (Create / Edit Company).
  - `src/components/Layout.tsx` → تخطيط عام (Layout) يتضمّن الشريط الجانبي وروابط التنقل.

- المكوّنات العامة المعاد استخدامها (موجودة الآن):
  - `src/components/CompanyCard.tsx` — مكون عرض بطاقة شركة داخل لائحة الشركات.
  - `src/components/Layout.tsx` — مكوّن الواجهة/الشريط الجانبي (Sidebar + Main).
  - `src/lib/api.ts` — العميل (Axios) مع الدوال التالية الموجودة: `fetchCompanies`, `createCompany`, `getCompany`, `updateCompany`, `toggleCompany`, `fetchCountries`, `fetchCountryWithProviders`.
  - `src/lib/types.ts` — تعريفات TypeScript لأنواع الإدخالات والمخرجات.

ملاحظة: لا توجد شاشات `Wallets` أو `Payments` أو `Dashboard` جاهزة حالياً في الشجرة؛ هذه الشاشات يجب إنشاؤها أو ربطها لاحقًا.

## 2. الأهداف التصميمية للنسخة المطوَّرة

- إدارة الشركات وـ API keys بسهولة:
  - إنشاء شركة جديدة.
  - عرض مفتاح API الخاص بكل شركة.
  - إمكانية إعادة توليد المفتاح (Regenerate) بموافقة المستخدم.
  - إمكانية تفعيل/تعطيل الشركة.

- إدارة المحافظ (wallets) المرتبطة بكل شركة:
  - عرض قائمة المحافظ لكل شركة.
  - إنشاء محفظة جديدة وتعيين daily_limit وغيره.
  - تعديل حالة المحفظة وتفاصيلها.

- سهولة الاستخدام للمستخدم العادي:
  - واجهات بحث وسريعة الاستجابة، وفلترة أعمدة.
  - جداول واضحة مع أعمدة قابلة للفرز والصفحات (pagination).
  - ألوان بسيطة ومتسقة مع إمكانية قراءة عالية.

## 3. قائمة الشاشات المقترحة

فيما يلي الشاشات المقترحة مع حالة الوجود الحالي وملحوظات سريعة للخطوات اللازمة:

- Dashboard رئيسية — **تحتاج إنشاء**
  - وصف: إحصائيات سريعة: عدد الشركات، عدد المحافظ النشطة، إجمالي المدفوعات اليوم.
  - ملاحظة: ليس هناك ملف لهذه الشاشة حاليًا؛ يمكن إنشاؤها كمكوّن جديد وربطه بالمسار `/`.

- شاشة Companies — **موجودة حالياً (قابلة للتحسين UX)**
  - ملفات: `src/routes/CompaniesList.tsx`, `src/routes/CompanyForm.tsx`, `src/components/CompanyCard.tsx`.
  - مطلوب تحسينات: إضافة جدول (Table) يدعم الفرز/الفلترة، وإضافة أزرار لنسخ/توليد API key مباشرة في القائمة.

- شاشة Wallets — **تحتاج إنشاء**
  - وصف: عرض المحافظ المرتبطة بالشركة المحددة، إدارة الحالة (enable/disable)، تعيين `daily_limit`.
  - ملاحظة: يجب إضافة صفحة مثل `src/routes/Wallets.tsx` وربطها بمسار مثل `/companies/:id/wallets` أو `/wallets` مع فلترة حسب الشركة.

- شاشة Payments — **تحتاج إنشاء**
  - وصف: عرض المدفوعات مع خيارات فلترة حسب الشركة والحالة، وعرض تفاصيل كل دفعة.
  - ملاحظة: يمكن البدء بشاشة بسيطة تعرض `/payments` ثم توسيع الفلاتر.

- صفحة Settings — **تحتاج إنشاء أو دمج**
  - وصف: إعدادات عامة مثل `BASE_API_URL`، لغة الواجهة.
  - ملاحظة: قد تُدمج في شاشة إعدادات صغيرة أو ضمن قائمة إدارية.

## 3.1 الخرائط بين الشاشات وواجهات الـ API

فيما يلي التوافق بين الشاشات الحالية/المقترحة وواجهات الـ API المتوفرة أو المتوقعة (مع ملاحظات على ما هو موجود بالفعل):

- شاشة Companies ↔ endpoints
  - موجود (مذكور في `src/lib/api.ts`):
    - `GET /admin/companies`  — جلب قائمة الشركات (`fetchCompanies`).
    - `POST /admin/companies` — إنشاء شركة (`createCompany`).
    - `GET /admin/companies/{id}` — جلب تفاصيل شركة (`getCompany`).
    - `PUT /admin/companies/{id}` — تحديث شركة (`updateCompany`).
    - `POST /admin/companies/{id}/toggle` — تبديل حالة الشركة (`toggleCompany`).
  - مقترحات/مفقودات محتملة:
    - `POST /admin/companies/{id}/regenerate-key` — توليد مفتاح جديد (Regenerate) — إن لم تكن متاحة يجب إضافتها في الـ API.

- شاشة Wallets ↔ endpoints
  - متوقع/مقترح:
    - `GET /admin/companies/{company_id}/wallets` — جلب محافظ الشركة.
    - `POST /admin/companies/{company_id}/wallets` — إنشاء محفظة.
    - `PUT /admin/wallets/{wallet_id}` — تحديث محفظة.
    - `PATCH /admin/wallets/{wallet_id}` — تفعيل/تعطيل محفظة.
  - ملاحظة: لا توجد دوال مذكورة حالياً في `src/lib/api.ts` لهذه النقاط؛ يجب التحقق من وجود هذه الـ endpoints في backend أو إضافتها.

- شاشة Payments ↔ endpoints
  - متوفر في backend (نقاط أساسية موجودة في الـ API العام):
    - `POST /wallets/request` — طلب محفظة متاحة (موجود في backend).
    - `GET /payments` — (متوقع) جلب قائمة المدفوعات.
    - `POST /payments/match`, `POST /payments/{id}/confirm-usage` — (موجودة في backend حسب الخدمة).
  - ملاحظة: تحقق من وجود واجهات لإدارة المدفوعات على مستوى الأدمن (إظهار / تصفية) وإضافتها إذا لم تكن موجودة.

--

ملاحظات نهائية:
- الشجرة الفعلية في `src/` تظهر تركيزًا حاليًا على إدارة الشركات (Companies). لذلك من الأفضل أن تبدأ المرحلة التالية بتعزيز شاشة Companies (تحسين UX/إضافة نسخ مفتاح وتوليده)، ثم إنشاء شاشة Wallets وربطها بنهاية API المناسبة، ثم إضافة Payments وDashboard.


## 4. تدفق العمل لإدارة المفاتيح (API Keys)

### 4.1 جلب الشركات

- المتوقّع من الـ API endpoint: `GET /admin/companies` أو `GET /companies` مع صلاحية إدارية.
- استجابة متوقعة: قائمة شركات تحتوي على `id`, `name`, `is_active`, `created_at`, `api_key` (أو حقل يظهر عند طلب التفاصيل).

### 4.2 عرض ونسخ الـ API Key

- في صف الشركة ضمن جدول `Companies` ضع زر/أيقونة `Copy API Key`:
  - عند الضغط يظهر الـ API key في مودال أو يظهر رمز نسخ مباشر.
  - استخدم مكتبة نسخ للحافظة (Clipboard API) لنسخ المفتاح بنقرة واحدة.

### 4.3 إنشاء شركة جديدة وتوليد مفتاح

- واجهة الإنشاء (`Create Company`): استمارة بها `name` و`is_active`.
- عند الإرسال يستدعي الواجهة الخلفية: `POST /admin/companies` (أو `POST /companies`) ويجب أن تُعيد الـ API المفتاح الجديد في الاستجابة.
  - إن لم يكن endpoint جاهزاً لإرجاع المفتاح، يمكن عرض رسالة تفيد إنشاء الشركة وتوجيه لصفحة التفاصيل حيث يُطلب استعراض المفتاح.

### 4.4 إعادة توليد المفتاح (Regenerate)

- زر `Regenerate API Key` في صف الشركة:
  - يطلب تأكيد المستخدم (Modal: "هل أنت متأكد؟") لأن التوليد سيبطل المفتاح السابق.
  - استدعاء: `POST /admin/companies/{company_id}/regenerate-key` أو `PUT /admin/companies/{company_id}/api_key`.
  - بعد النجاح: عرض المفتاح الجديد مع زر نسخ.

### 4.5 تفعيل/تعطيل الشركة

- زر `Enable/Disable` يقوم بتغيير حالة `is_active` عبر `PATCH /admin/companies/{id}` مع الحقل `is_active`.
- تأثير التفعيل/التعطيل:
  - عند تعطيل شركة، تُرفض طلبات API التي تستخدم مفاتيحها (تُرجع 401/403 أو رسالة مناسبة).
  - في الواجهة، تعرض حالة `Disabled` بلون واضح وتمنع إجراءات حساسة مثل توليد المفتاح (ما لم يُسمح صراحةً).

## 5. خطة تطوير تدريجية للـ frontend (مراحل)

- المرحلة 1 — بنية وتنظيف
  - تنظيف بنية `src/`، توحيد مكوّنات الـ UI الأساسية (Button, Modal, Table).
  - إضافة صفحة `Companies` بسيطة تعرض قائمة الشركات عبر `GET /admin/companies`.

- المرحلة 2 — عمليات CRUD أساسية
  - إضافة إنشاء شركة (`Create`), تعديل (`Edit`), عرض التفاصيل (`Details`) مع عرض الـ API key.
  - تنفيذ وظيفة `Copy API Key` و`Regenerate API Key` بتعامل مع الـ API.

- المرحلة 3 — تحسين تجربة المستخدم
  - إضافة بحث (global search)، فلترة أعمدة، وترقيم صفحات (pagination).
  - تحسين التنبيهات (Toasts) والموافقة (Confirm dialogs).

- المرحلة 4 — ربط المحافظ والمدفوعات
  - إضافة شاشة `Wallets` متصلة بكل شركة: قائمة + إنشاء/تعديل/تفعيل.
  - إضافة شاشة `Payments` مع فلترة حسب الشركة والحالة.

## 6. ملاحظات تقنية وممارسات مقترحة

- اعتماد Axios أو fetch مع ملف `src/lib/api.ts` يحتوي على تكوين `BASE_API_URL` وinterceptors للخطأ.
- استخدام مكوّن جدول قابل لإعادة الاستخدام يدعم الأعمدة القابلة للفرز والفلترة.
- اعتماد نظام ألوان متباينة للـ states: active (أخضر)، disabled (رمادي)، warning (برتقالي).
- تخزين المفاتيح الحساسة في الواجهة لا يتم إطلاقاً — فقط عرضها مؤقتاً للنسخ عند إنشائها أو إعادة توليدها.

## 7. خطوات قبل البدء بالتنفيذ

1. استعرض `admin-frontend/src/` وحدّد الملفات/المكوّنات الحالية وماذا يمكن إعادة استخدامه.
2. تأكد من وجود endpoints الإدارية في الـ API (routes لإدارة الشركات/المحافظ/المفاتيح).
3. صِف واجهة الـ API المتوقعة بدقة مع فريق الـ backend إن لم تكن موجودة بالفعل.

---

هذا المستند خطة تمهيدية مبسطة لبدء عمل واجهة إدارة مناسبة لإدارة الشركات، مفاتيح الـ API، المحافظ والمدفوعات. عند الموافقة على الخطة يمكن تحويلها إلى تذاكر تنفيذية تفصيلية (issues) لكل مرحلة ومهمة.

