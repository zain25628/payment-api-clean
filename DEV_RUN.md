# تشغيل بيئة التطوير (Backend + Frontend)

هذا المستند يشرح باختصار كيفية تشغيل المشروع محليًا في وضع التطوير باستخدام السكربت الموحد `dev_start_stack.ps1`.

**الملف الرئيسي لتشغيل الستاِك:** `dev_start_stack.ps1` (موجود في جذر المشروع).

## المتطلبات المسبقة

- Python مثبتة على الجهاز. يُفضّل وجود مجلد افتراضي `.venv` في جذر المشروع يحتوي على البيئة الافتراضية والمكتبات (تثبيت عبر `python -m venv .venv` ثم `pip install -r requirements.txt`).
- Node.js و `npm` مثبتان لتشغيل واجهة الإدارة (`npm run dev`).
- تأكد أن الأوامر `python`, `pwsh` (PowerShell Core) و `npm` متاحة في الـ PATH.

## خطوات سريعة لتشغيل (VS Code)

1. افتح VS Code وادخل: `File → Open Folder...` ثم اختر المجلد:

   `C:\Users\zaink\OneDrive\Desktop\api`

2. افتح الطرفية المدمجة (Integrated Terminal):
   - من القائمة: `Terminal → New Terminal`، أو
   - الاختصار: `` Ctrl+` ``، أو
   - بزر الفأرة الأيمن على المجلد في Explorer → `Open in Integrated Terminal`.

3. تأكد أن الطرفية تعمل في جذر المشروع. إن لزم نفّذ:

```powershell
cd C:\Users\zaink\OneDrive\Desktop\api
```

4. شغّل السكربت الموحد لتشغيل الـ backend والـ frontend:

```powershell
pwsh -File .\dev_start_stack.ps1
```

- ملاحظة بديلة: إذا لم يكن `pwsh` متوفراً يمكنك تشغيل السكربت باستخدام Windows PowerShell مباشرة (من داخل المجلد):

```powershell
.\dev_start_stack.ps1
```

### تنبيه عند نسخ أوامر PowerShell

- عند نسخ أوامر من هذه الوثيقة أو من الطرفية، لاحظ أن أي سطر يبدأ بموجّه PowerShell مثل `PS C:\...>` أو يظهر بادئة `(venv)` هو مجرد مخرجات/سجلّ موجود في الطرفية، ولا يُعد أمرًا يجب لصقه وتنفيذه.
- الأوامر التي يجب تشغيلها تكون فقط على شكل أسطر نظيفة مثل:

   ```powershell
   node -v
   npm -v
   npm install
   npm run dev
   ```

   بدون أي نصوص أو أحرف قبلها (مثل `PS C:\...>` أو `(venv)`) أو بعدها.

## ماذا يفعل السكربت

- يحاول تفعيل البيئة الافتراضية `.venv` إن وُجدت.
- يبدأ خادم الـ API (uvicorn) على عادةً: `http://localhost:8000`.
- يحدِّد مجلد الواجهة الأمامية الذي يحتوي `package.json` (مثل `admin-frontend`) ويشغِّل `npm run dev` لبدء لوحة التحكم (عادة على `http://localhost:5173`).
- لا يعدّل أي ملفات في المشروع، فقط يبدأ العمليات اللازمة.

## جمع اللوجز عند حدوث خطأ

إذا ظهر أي خطأ أثناء التشغيل أو أثناء استخدام الواجهة، افعل ما يلي قبل مشاركة المشكلة:


ملاحظة: لا تقم بتعديل أي ملفات لكى تحاول إصلاح الخطأ قبل مشاركة اللوجز؛ سنحلّل اللوجز أولاً ثم نقدم تغييرات مقترحة.


## تشغيل الاختبارات (Backend)

- الطريقة المفضّلة لتشغيل الاختبارات هي استخدام السكربت `run_tests.ps1` الموجود في جذر المشروع.

   مثال سريع لتشغيل السكربت من PowerShell:

   ```powershell
   cd C:\Users\zaink\OneDrive\Desktop\api
   pwsh -File .\run_tests.ps1
   ```

   السكربت سيتكفّل بتفعيل `.venv`، تشغيل `pytest`، ومن ثم إرجاع كود الخروج الناتج.

### تشغيل يدوي بدلاً من السكربت

- المتطلبات المسبقة: تفعيل البيئة الافتراضية للمشروع (`.venv`) وتثبيت متطلبات التطوير إن لم تكن مثبتة (مثلاً إذا لم تثبت بعد، شغّل `pip install -r requirements.txt`).

- الأوامر اليدوية الموصى بها لتشغيل مجموعة اختبارات الـ Python (من جذر المشروع):

   ```powershell
   cd C:\Users\zaink\OneDrive\Desktop\api
   .\.venv\Scripts\Activate.ps1
   python -m pytest -q
   ```

   ملاحظة: بعد تفعيل البيئة الافتراضية يمكنك أيضاً تشغيل `pytest` مباشرة إذا تفضل ذلك (`pytest -q`).

- ملاحظة قصيرة عند فشل الاختبارات: إذا فشلت الاختبارات، انسخ الـ Traceback الكامل الذي يظهر في الطرفية والصقه في قالب تقرير التشغيل لدينا عند مشاركة المشكلة، مع أية معلومات إضافية (أوامر شغّلتها، أي متغيرات بيئة مهمة).
إذا رغبت أقدر أضيف قسم "تشغيل مرئي" يفتح نوافذ PowerShell جديدة لكل خدمة لعرض اللوجز مباشرة، أو أضيف خيار `--dry-run` للسكربت لعرض ما سيُشغّل فقط. أخبرني أي خيار تفضّل.

## اختبار لوحة المحافظ (Company Wallets)

- افتح لوحة الإدارة كما في الأعلى (شغّل `npm run dev` داخل `admin-frontend` أو استخدم `dev_start_stack.ps1` كما هو موضح).
- اذهب إلى صفحة الشركات: `http://localhost:5173/companies` (أو المسار المحلي الذي يشغّل الـ frontend).
- بجانب كل شركة ستجد زر `Wallets` — اضغطه لفتح صفحة المحافظ لتلك الشركة: `/companies/{id}/wallets`.

صفحة المحافظ تعرض قائمة المحافظ الخاصة بالشركة مع الأعمدة التالية:

- Label
- Identifier
- Provider (يعرض `provider_name` أو `provider_code` إذا كان الاسم غير متوفر)
- Active (حالة المحفظة)

لكل صف يوجد زر `Toggle Active` لتبديل حالة المحفظة. عند الضغط يتم استدعاء الـ API المناسب لإجراء التبديل وتحديث الحالة محليًا في الصفحة.

في حال حدوث خطأ (مثل فشل تحميل قائمة المحافظ أو فشل تبديل الحالة):

- ستظهر رسالة حمراء أعلى الصفحة توضح الخطأ. يُرجى نسخ هذه الرسالة.
- افتح Console في المتصفح (DevTools) وانسخ أي رسائل خطأ أو Stack traces موجودة هناك.
- انسخ أيضاً سجلات الـ backend (Integrated Terminal أو نوافذ PowerShell التي شغّلت الـ backend) إن وجدت أية Tracebacks.

الصق كل ما سبق (رسالة الخطأ من الواجهة، Console logs، backend logs) في قالب تقرير التشغيل الذي أنشأناه لكي أتمكن من تحليل المشكلة بسرعة.

## مؤشر حالة الـ API في لوحة الإدارة

- شريط أعلى كل صفحة في لوحة الإدارة يعرض Badge صغيرة لحالة الـ API بثلاث حالات تقريبية:

   - **API: OK (أخضر)** — الاتصال بنقطة `GET /health` ناجح والباك‌اند مستجيب.
   - **API: Checking... (رمادي)** — يتم تنفيذ فحص `GET /health` حالياً (عادة عند فتح الصفحة أو عند الضغط على "Retry").
   - **API: DOWN (أحمر)** — فحص `GET /health` فشل، والـ backend قد يكون متوقفًا أو غير متاح.

- يظهر زر **Retry** فقط عند حالة الخطأ (`API: DOWN`). اضغطه لإعادة تشغيل فحص الصحة (`/health`).

- إذا بقيت الحالة على **DOWN** بعد عدة محاولات، يُنصَح بما يلي:

   - تأكد من تشغيل الـ backend (مثلاً عبر `pwsh -File .\dev_start_stack.ps1` أو بتشغيل `python -m uvicorn app.main:app --reload --port 8000` كما هو موضح أعلاه).
   - انسخ رسالة الخطأ الظاهرة على واجهة اللوحة (الرسالة الحمراء إن وُجدت).
   - افتح Console في المتصفح (DevTools) وانسخ أي رسائل أو Stack traces ظهرت هناك.
   - انسخ سجلات الـ backend (Integrated Terminal أو أي نوافذ PowerShell/terminals المفتوحة) التي تحتوي على Traceback أو رسائل خطأ.

- ألصق هذه المعلومات (رسالة الواجهة + console logs + backend logs) في قالب تقرير التشغيل الذي أُنشئَ سابقًا عند مشاركة المشكلة، حتى أتمكن من تحليلها وإرشادك للحل.